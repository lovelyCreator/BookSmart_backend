"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,n=new Array(e.length);r<e.length;r++)n[r]=e[r];return n}}var _require=require("socket.io"),Server=_require.Server,mongoose=require("mongoose"),createSocketServer=function(e){var u=new Server(e,{cors:{origin:"*",methods:["GET","POST"]}}),r=require("./models"),i=r.chats,c=r.chatusers;u.on("connection",function(s){console.log("a user connected"),s.on("format",function(r){var n,a,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.walletAddress,console.log("wallet: ",n),t={logined:!(a={walletAddress:n})},e.next=6,regeneratorRuntime.awrap(c.updateOne(a,t));case 6:e.sent;case 7:case"end":return e.stop()}})}),s.on("wallet",function(r){var n,s,a,t,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.walletAddress,e.next=3,regeneratorRuntime.awrap(c.findOne({walletAddress:n}));case 3:if(!(s=e.sent)){e.next=20;break}if(0<s.unreadmsg.length)return s.unreadmsg.map(function(r){var n,a,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(i.findOne({id:r}));case 2:if(null!=(n=e.sent)){e.next=6;break}e.next=14;break;case 6:return a={id:r},t={readed:[].concat(_toConsumableArray(n.readed),[s.username])},e.next=10,regeneratorRuntime.awrap(i.updateOne(a,t));case 10:return e.sent,e.next=13,regeneratorRuntime.awrap(i.findOne({id:r}));case 13:e.sent;case 14:case"end":return e.stop()}})}),a={username:s.username},t={unreadmsg:[]},e.next=11,regeneratorRuntime.awrap(c.updateOne(a,t));e.next=20;break;case 11:return e.sent,e.next=14,regeneratorRuntime.awrap(c.findOne({username:s.username}));case 14:return e.sent,e.next=17,regeneratorRuntime.awrap(i.find({}));case 17:o=e.sent,u.emit("checked",o),u.emit("Alert",{walletAddress:s.walletAddress,alert:0});case 20:case"end":return e.stop()}})}),s.on("login",function(r){var n,t,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("sdfsfsdf"),console.log(r),e.next=4,regeneratorRuntime.awrap(c.findOne({username:r.username}));case 4:if(n=e.sent,console.log("existingUser:",n),!n){e.next=11;break}"user is already existed.",u.to(s.id).emit("userexist","user is already existed."),e.next=23;break;case 11:return(t=new c({id:s.id,username:r.username,walletAddress:r.walletAddress,avatar:r.avatarUrl,logined:!0,unreadmsg:[]})).save(),u.to(s.id).emit("login",t),e.next=16,regeneratorRuntime.awrap(i.find({}));case 16:return e.sent.map(function(r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={id:r.id},a={readed:[t.username]},e.next=4,regeneratorRuntime.awrap(i.updateOne(n,a));case 4:e.sent;case 5:case"end":return e.stop()}})}),e.next=20,regeneratorRuntime.awrap(i.find({}));case 20:a=e.sent,console.log("readed",a),u.emit("checked",a);case 23:case"end":return e.stop()}})}),s.on("logout",function(r){var n,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={username:r.username},a={logined:r.logined},e.next=4,regeneratorRuntime.awrap(c.updateOne(n,a));case 4:e.sent;case 5:case"end":return e.stop()}})}),s.on("message",function(a){var t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:t=[],s=mongoose.Types.ObjectId(),c.aggregate([{$match:{logined:!0}},{$project:{_id:0,username:1,avatar:1}}],function(e,r){if(!e){r.map(function(e,r){e.username!=a.username&&t.push(e.username)}),console.log(a.username,a.message);var n=new i({id:s,userName:a.username,avatar:a.avatar,message:a.message,image:a.image,timestamp:new Date,readed:t});n.save().then(function(e){console.log("Successfully Created!")}),u.emit("message",n)}}),c.aggregate([{$match:{logined:!1}},{$project:{_id:0,username:1,unreadmsg:2}}],function(e,r){e||r.map(function(r){var n,a,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={username:r.username},a={unreadmsg:[].concat(_toConsumableArray(r.unreadmsg),[s])},e.next=4,regeneratorRuntime.awrap(c.updateOne(n,a));case 4:return e.sent,e.next=7,regeneratorRuntime.awrap(c.findOne({username:r.username}));case 7:t=e.sent,u.emit("Alert",{walletAddress:t.walletAddress,alert:t.unreadmsg.length}),console.log("up",t);case 10:case"end":return e.stop()}})})});case 4:case"end":return e.stop()}})}),s.on("upload",function(a){var t=[],s=mongoose.Types.ObjectId();c.aggregate([{$match:{logined:!0}},{$project:{_id:0,username:1,avatar:2}}],function(e,r){if(!e){r.map(function(e,r){e.username!=a.username&&t.push(e.username)});var n=new i({id:s,userName:a.username,avatar:a.avatar,message:a.message,timestamp:new Date,readed:t});n.save(),u.emit("message",n)}}),c.aggregate([{$match:{logined:!1}},{$project:{_id:0,username:1,unreadmsg:2}}],function(e,r){e||r.map(function(r){var n,a,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n={username:r.username},a={unreadmsg:[].concat(_toConsumableArray(r.unreadmsg),[s])},e.next=4,regeneratorRuntime.awrap(c.updateOne(n,a));case 4:return e.sent,e.next=7,regeneratorRuntime.awrap(c.findOne({username:r.username}));case 7:t=e.sent,u.emit("Alert",{walletAddress:t.walletAddress,alert:t.unreadmsg.length}),console.log("up",t);case 10:case"end":return e.stop()}})})})}),s.on("disconnect",function(){console.log("Client disconnected")})})};module.exports=createSocketServer;
//# sourceMappingURL=socketServer.min.js.map
